<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leaf Scan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 min-h-screen flex items-center justify-center">

  <div class="bg-slate-700 p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl text-white font-bold text-center mb-4">
      ðŸŒ¿ Leaf Plant Identification
    </h1>

    <!-- Upload -->
    <input
      type="file"
      id="imageInput"
      accept="image/*"
      class="hidden"
    />
    <label
      for="imageInput"
      class="block bg-slate-700 text-white text-center py-2 rounded-lg cursor-pointer mb-4"
    >
      Choose Leaf Image
    <!-- Image Preview -->
    <img
      id="preview"
      class="hidden w-full h-64 object-contain bg-grey-100 rounded mb-3"
    />

    <!-- Predict Button -->
    <button
      onclick="predict()"
      class="bg-green-600 text-white w-full py-2 rounded hover:bg-green-700"
    >
      Predict
    </button>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden text-center mt-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
      <p class="text-sm mt-2">Analyzing leaf...</p>
    </div>

    <!-- Result -->
    <div id="result" class="hidden mt-4">
      <p class="text-lg">
        Top Prediction:
        <a
          id="plantLink"
          href="#"
          class="text-green-700 font-semibold underline"
        ></a>
      </p>

      <!-- Confidence Bar -->
      <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
        <div
          id="confidenceBar"
          class="h-4 rounded-full bg-green-500"
          style="width: 0%"
        ></div>
      </div>

      <p id="confidenceText" class="text-sm mt-1"></p>

      <!-- Top 3 Predictions -->
      <div id="top3" class="mt-4 text-sm"></div>
    </div>

    <!-- Error -->
    <p id="error" class="text-red-500 mt-3"></p>
  </div>

  <script>
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const resultBox = document.getElementById("result");
    const errorBox = document.getElementById("error");
    const plantLink = document.getElementById("plantLink");
    const confidenceBar = document.getElementById("confidenceBar");
    const confidenceText = document.getElementById("confidenceText");
    const top3Div = document.getElementById("top3");
    const loading = document.getElementById("loading");

    // Image preview
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;

      preview.src = URL.createObjectURL(file);
      preview.classList.remove("hidden");
      resultBox.classList.add("hidden");
      errorBox.textContent = "";
    });

    async function predict() {
      const file = imageInput.files[0];
      if (!file) {
        errorBox.textContent = "Please select an image first.";
        return;
      }

      const formData = new FormData();
      formData.append("image", file);

      loading.classList.remove("hidden");
      resultBox.classList.add("hidden");
      errorBox.textContent = "";

      try {
        const response = await fetch("http://127.0.0.1:5000/predict", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        loading.classList.add("hidden");

        if (data.error) {
          errorBox.textContent = data.error;
          return;
        }

        const top3 = data.top_predictions;
        const best = top3[0];

        // Main result
        plantLink.textContent = best.plant;
        plantLink.href = `plant.html?name=${encodeURIComponent(best.plant)}`;

        confidenceText.textContent = `Confidence: ${best.confidence}%`;
        confidenceBar.style.width = best.confidence + "%";

        // Confidence color
        confidenceBar.className =
          best.confidence >= 70
            ? "h-4 rounded-full bg-green-500"
            : best.confidence >= 50
            ? "h-4 rounded-full bg-yellow-500"
            : "h-4 rounded-full bg-red-500";

        // Top 3 list
        top3Div.innerHTML =
          "<strong>Top 3 Predictions:</strong><ul class='mt-2 list-disc pl-5'>";

        top3.forEach(item => {
          top3Div.innerHTML +=
            `<li>${item.plant} â€” ${item.confidence}%</li>`;
        });

        top3Div.innerHTML += "</ul>";

        resultBox.classList.remove("hidden");
      } catch (err) {
        loading.classList.add("hidden");
        errorBox.textContent = "Failed to connect to API.";
      }
    }
  </script>

</body>
</html>
